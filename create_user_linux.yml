---
- name: Create Pikachu User Across Different OS Families
  hosts: linux_hosts
  # 'become' is required for Linux but handled differently for VyOS
  become: "{{ false if ansible_network_os is defined else true }}"
  tasks:
    # --- LINUX HOSTS (Ubuntu, Fedora, Oracle) ---
    - name: Ensure the sudo group exists (RedHat/Fedora/Oracle use 'wheel')
      ansible.builtin.group:
        name: "{{ 'wheel' if ansible_os_family in ['RedHat', 'Oracle Linux'] else 'sudo' }}"
        state: present
      when: ansible_network_os is not defined

    - name: Create Pikachu on Linux machines
      ansible.builtin.user:
        name: Pikachu
        # Generates a hashed version of 'changeme'
        password: "{{ 'changeme' | password_hash('sha512') }}"
        shell: /bin/bash
        # Adds user to the correct admin group for that OS
        groups: "{{ 'wheel' if ansible_os_family in ['RedHat', 'Oracle Linux'] else 'sudo' }}"
        append: yes
        state: present
      when: ansible_network_os is not defined

# --- VyOS Task using Raw Config ---
    - name: Create Pikachu on VyOS using raw commands
      vyos.vyos.vyos_config:
        lines:
          - set system login user Pikachu full-name "Pikachu Admin"
          - set system login user Pikachu authentication plaintext-password "changeme"
          # We send 15 because we know the router accepts it, and this module won't block us
          - set system login user Pikachu level 15
      when: "'vyos' in group_names"